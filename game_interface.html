<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Swedish City Sustainability Game</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --light: #ecf0f1;
            --dark: #34495e;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #cd1e98, #1a2a6c);
            color: white;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        header {
            text-align: center;
            padding: 20px 0;
            margin-bottom: 30px;
            width: 100%;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .game-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
            min-width: 0;
        }
        
        .panel {
            background: rgba(44, 62, 80, 0.8);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(1, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: rgba(52, 73, 94, 0.7);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .money { color: #f1c40f; }
        .happiness { color: #2ecc71; }
        .co2 { color: #e74c3c; }
        .year { color: #3498db; }
        
        .progress-bar {
            height: 10px;
            background: rgba(255,255,255,0.1);
            border-radius: 5px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .progress-fill {
            height: 100%;
        }
        
        .controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .control-group {
            margin-bottom: 20px;
        }
        
        .control-group h3 {
            margin-bottom: 10px;
            color: var(--secondary);
        }
        
        .buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        button {
            background: var(--secondary);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 100px;
        }
        
        button:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        button.active {
            background: var(--success);
            box-shadow: 0 0 10px rgba(46, 204, 113, 0.5);
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        .btn-primary {
            background: var(--success);
            flex: 1;
            padding: 15px;
            font-size: 1.1rem;
        }
        
        .btn-danger {
            background: var(--danger);
        }
        
        .news-panel {
            grid-column: span 1;
        }
        
        .news-card {
            background: rgba(41, 128, 185, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            animation: fadeIn 0.5s ease;
        }
        
        .news-title {
            font-size: 1.4rem;
            margin-bottom: 10px;
            color: var(--warning);
        }
        
        .news-description {
            line-height: 1.6;
            margin-bottom: 15px;
        }
        
        .effects {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .effect {
            background: rgba(0,0,0,0.2);
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        
        .chart-container {
            height: 200px;
            margin: 15px 0;
        }
        
        .map-container {
            display: flex;
            position: relative;
            height: 600px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
        }
        
        .sweden-map {
            position: relative;
            height: 600px;
            flex: 2;
            background: url('se.svg') no-repeat center;
            background-size: contain;
            margin: 0 auto;
        }
        
        .video-player {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            height: 168px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
            border: 3px solid rgba(255, 255, 255, 0.4);
            z-index: 20;
        }
        
        .video-player video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .map-sidebar {
            flex: 1;
            min-width: 270px;
            padding: 15px;
            background: rgba(44, 62, 80, 0.9);
            border-radius: 0;
            overflow-y: auto;
            max-height: 100%;
            border-left: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .city-marker {
            position: absolute;
            width: 18px;
            height: 18px;
            background: var(--secondary);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 3px solid white;
            box-shadow: 0 0 10px rgba(0,0,0,0.7);
            z-index: 10;
        }
        
        .city-marker:hover {
            transform: translate(-50%, -50%) scale(1.5);
            box-shadow: 0 0 15px rgba(52, 152, 219, 0.9);
        }
        
        .city-marker.active {
            background: var(--success);
            box-shadow: 0 0 15px rgba(46, 204, 113, 0.9);
            border-color: #fff;
            z-index: 20;
        }
        
        .city-marker.eliminated {
            background: var(--danger);
            opacity: 0.7;
            border-color: rgba(255, 255, 255, 0.5);
        }
        
        .city-name {
            position: absolute;
            color: white;
            font-weight: bold;
            font-size: 0.85rem;
            text-shadow: 0 0 5px rgba(0,0,0,1), 0 0 10px rgba(0,0,0,1);
            white-space: nowrap;
            top: -22px;
            background: rgba(44, 62, 80, 0.7);
            padding: 2px 8px;
            border-radius: 10px;
            transform: translateX(-50%);
        }
        
        .city-info {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .city-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .no-city-selected {
            text-align: center;
            padding: 30px;
            color: var(--light);
            font-style: italic;
        }
        
        .game-over {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            display: none;
        }
        
        .game-over-content {
            background: var(--dark);
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            max-width: 500px;
            width: 90%;
        }
        
        .game-over h2 {
            font-size: 2.5rem;
            color: var(--danger);
            margin-bottom: 20px;
        }
        
        .game-over p {
            margin-bottom: 30px;
            font-size: 1.2rem;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .pulse {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .projected-changes {
            margin-top: 15px;
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            border: 1px dashed rgba(255,255,255,0.3);
        }
        
        .projected-changes h4 {
            margin: 0 0 10px 0;
            color: #3498db;
            font-size: 0.9rem;
        }
        
        .projected-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.85rem;
        }
        
        .projected-item .label {
            color: #bdc3c7;
        }
        
        .projected-item .value {
            font-weight: bold;
        }
        
        .projected-item .value.positive {
            color: #2ecc71;
        }
        
        .projected-item .value.negative {
            color: #e74c3c;
        }
        
        .projected-item .value.neutral {
            color: #f1c40f;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Swedish City Sustainability Game</h1>
            <p class="subtitle">Balance money, happiness and CO2 emissions to create sustainable Swedish cities</p>
        </header>
        
        <div class="game-container">
            <div class="panel stats-panel">
                <div class="stats">
                    <div class="stat-card">
                        <h3>Game Year</h3>
                        <div class="stat-value year" id="year">1</div>
                    </div>
                    <div class="stat-card">
                        <h3>National Money (SEK)</h3>
                        <div class="stat-value money" id="money">1000</div>
                        <div class="progress-bar">
                            <div class="progress-fill money" style="width: 100%; background: #f1c40f;"></div>
                        </div>
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn-primary pulse" id="next-round">Next Round</button>
                    <button class="btn-danger" id="restart">Restart</button>
                </div>
            </div>
            
            <div class="panel">
                <h2>Sweden Map</h2>
                <div class="map-container">
                    <div class="sweden-map" id="sweden-map">
                        <!-- City markers will be added dynamically -->
                    </div>
                    <div class="video-player">
                        <video id="background-video" autoplay loop muted playsinline>
                            <source src="" type="video/mp4">
                            您的浏览器不支持视频播放。
                        </video>
                    </div>
                    <div class="map-sidebar" id="city-details">
                        <div class="no-city-selected">
                            Please click on a city on the map to view details
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="panel news-panel">
                <h2>Latest News</h2>
                <div id="news-container">
                    <div class="news-card">
                        <div class="news-title">Welcome to the Swedish City Sustainability Game</div>
                        <div class="news-description">
                            As the manager of Sweden, your task is to balance economic development, citizen happiness, and environmental protection.
                            Each round, you can choose different transportation methods and energy sources for each city, and the system will preview the effects without applying them immediately.
                            Click the "Next Round" button to apply all changes and advance to the next year. New events will happen each year, so make wise decisions!
                        </div>
                        <div class="effects">
                            <div class="effect">Goal: Keep national money > 0</div>
                            <div class="effect">Goal: Prevent city happiness from reaching 0</div>
                            <div class="effect">Goal: Prevent city CO2 from reaching 100</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="game-over" id="game-over">
        <div class="game-over-content">
            <h2>Game Over</h2>
            <p id="game-over-message">Your country failed to achieve sustainable development</p>
            <button class="btn-primary" id="restart-game">Restart Game</button>
        </div>
    </div>
    
    <!-- City detail template (hidden) -->
    <template id="city-template">
        <div class="city-info">
            <h3 class="city-title">City Name</h3>
            <div class="city-stats">
                <div class="stat-card">
                    <h3>Happiness</h3>
                    <div class="stat-value happiness city-happiness">50</div>
                    <div class="progress-bar">
                        <div class="progress-fill happiness" style="width: 50%; background: #2ecc71;"></div>
                    </div>
                </div>
                <div class="stat-card">
                    <h3>CO2 Emissions</h3>
                    <div class="stat-value co2 city-co2">50</div>
                    <div class="progress-bar">
                        <div class="progress-fill co2" style="width: 50%; background: #e74c3c;"></div>
                    </div>
                </div>
            </div>
            
            <div class="chart-container">
                <canvas class="city-chart"></canvas>
            </div>
            
            <div class="control-group">
                <h3>Transportation</h3>
                <div class="buttons transportation-buttons">
                    <button data-type="bicycle">Bicycle</button>
                    <button data-type="scooter">E-Scooter</button>
                    <button data-type="car">Car</button>
                    <button data-type="electronic_car">Electric Car</button>
                    <button data-type="bus">Bus</button>
                    <button data-type="electronic_bus">Electric Bus</button>
                    <button data-type="train">Train</button>
                    <button data-type="airplane">Airplane</button>
                    <button data-type="potogan">Future Transit</button>
                </div>
            </div>
            
            <div class="control-group">
                <h3>Energy Source</h3>
                <div class="buttons energy-buttons">
                    <button data-type="mining">Mining</button>
                    <button data-type="water">Hydro</button>
                    <button data-type="nuclear">Nuclear</button>
                    <button data-type="solar">Solar</button>
                    <button data-type="wind">Wind</button>
                    <button data-type="automic">Automated</button>
                    <button data-type="anti_material">Antimatter</button>
                </div>
            </div>
            
            <div class="projected-changes">
                <h4>Projected changes this round:</h4>
                <div class="projected-item">
                    <span class="label">Money:</span>
                    <span class="value neutral projected-money">0</span>
                </div>
                <div class="projected-item">
                    <span class="label">Happiness:</span>
                    <span class="value neutral projected-happiness">0</span>
                </div>
                <div class="projected-item">
                    <span class="label">CO2 Emissions:</span>
                    <span class="value neutral projected-co2">0</span>
                </div>
            </div>
        </div>
    </template>
    
    <script>
        // Game state
        let gameState = {
            money: 1000,
            year: 1,
            cities: {
                stockholm: {
                    name: "Stockholm", 
                    happiness: 60,
                    co2: 40,
                    transportation: "bicycle",
                    energy_source: "solar",
                    eliminated: false,
                    position: {x: 300, y: 180}
                },
                gothenburg: {
                    name: "Gothenburg", 
                    happiness: 50,
                    co2: 45,
                    transportation: "bicycle",
                    energy_source: "solar",
                    eliminated: false,
                    position: {x: 150, y: 300}
                },
                malmo: {
                    name: "Malmö", 
                    happiness: 55,
                    co2: 50,
                    transportation: "bicycle",
                    energy_source: "solar",
                    eliminated: false,
                    position: {x: 180, y: 420}
                }
            },
            game_over: false
        };
        
        // Currently selected city
        let selectedCity = null;
        
        // City chart instances
        const cityCharts = {};
        
        // Video management
        const videos = [
            'videos/download.mp4',
            'videos/download (1).mp4',
            'videos/download (2).mp4',
            'videos/download (3).mp4'
        ];
        let currentVideoIndex = 0;
        
        // DOM elements
        const yearElement = document.getElementById('year');
        const moneyElement = document.getElementById('money');
        const newsContainer = document.getElementById('news-container');
        const nextRoundButton = document.getElementById('next-round');
        const restartButton = document.getElementById('restart');
        const gameOverScreen = document.getElementById('game-over');
        const gameOverMessage = document.getElementById('game-over-message');
        const restartGameButton = document.getElementById('restart-game');
        const swedenMap = document.getElementById('sweden-map');
        const cityDetails = document.getElementById('city-details');
        const cityTemplate = document.getElementById('city-template');
        const backgroundVideo = document.getElementById('background-video');
        
        // Initialize video player
        function initVideoPlayer() {
            backgroundVideo.src = videos[currentVideoIndex];
            
            // Remove auto-switch on video end, only loop current video
            backgroundVideo.addEventListener('ended', () => {
                backgroundVideo.play();
            });
            
            // Ensure video plays automatically
            backgroundVideo.addEventListener('canplaythrough', () => {
                backgroundVideo.play().catch(e => {
                    console.log('Autoplay prevented:', e);
                });
            });
        }
        
        // Switch to next video manually
        function switchToNextVideo() {
            currentVideoIndex = (currentVideoIndex + 1) % videos.length;
            backgroundVideo.src = videos[currentVideoIndex];
            backgroundVideo.play().catch(e => {
                console.log('Video play failed:', e);
            });
        }
        
        // Initialize city markers on the map
        function initCityMarkers() {
            swedenMap.innerHTML = '';
            
            for (const [cityId, city] of Object.entries(gameState.cities)) {
                const marker = document.createElement('div');
                marker.className = `city-marker ${city.eliminated ? 'eliminated' : ''}`;
                marker.id = `marker-${cityId}`;
                marker.dataset.cityId = cityId;
                marker.style.left = `${city.position.x}px`;
                marker.style.top = `${city.position.y}px`;
                
                const cityName = document.createElement('div');
                cityName.className = 'city-name';
                cityName.textContent = city.name;
                
                marker.appendChild(cityName);
                swedenMap.appendChild(marker);
                
                marker.addEventListener('click', () => {
                    if (!city.eliminated) {
                        selectCity(cityId);
                    } else {
                        alert(`${city.name} has been eliminated and cannot be selected`);
                    }
                });
            }
        }
        
        // Select a city
        function selectCity(cityId) {
            if (gameState.cities[cityId].eliminated) {
                alert(`${gameState.cities[cityId].name} has been eliminated and cannot be selected`);
                return;
            }
            
            // Update selection state
            selectedCity = cityId;
            
            // Update marker styles
            document.querySelectorAll('.city-marker').forEach(marker => {
                marker.classList.remove('active');
            });
            document.getElementById(`marker-${cityId}`).classList.add('active');
            
            // Show city details
            updateCityDetails();
        }
        
        // Update city detail panel
        function updateCityDetails() {
            if (!selectedCity) {
                cityDetails.innerHTML = '<div class="no-city-selected">Please click on a city on the map to view details</div>';
                return;
            }
            
            const city = gameState.cities[selectedCity];
            
            // Clone template
            const cityInfo = cityTemplate.content.cloneNode(true);
            
            // Update city information
            cityInfo.querySelector('.city-title').textContent = city.name;
            cityInfo.querySelector('.city-happiness').textContent = city.happiness;
            cityInfo.querySelector('.city-co2').textContent = city.co2;
            
            // Update progress bars
            cityInfo.querySelector('.progress-fill.happiness').style.width = `${city.happiness}%`;
            cityInfo.querySelector('.progress-fill.co2').style.width = `${city.co2}%`;
            
            // Get projected effects
            const projectedEffects = gameState.current_round_changes?.projected_effects?.[selectedCity] || {
                money: 0, 
                happiness: 0, 
                co2: 0
            };
            
            // Update projected changes display
            const projectedMoney = cityInfo.querySelector('.projected-money');
            const projectedHappiness = cityInfo.querySelector('.projected-happiness');
            const projectedCo2 = cityInfo.querySelector('.projected-co2');
            
            // Set money value and style
            projectedMoney.textContent = projectedEffects.money > 0 ? `+${projectedEffects.money}` : projectedEffects.money;
            projectedMoney.className = `value ${projectedEffects.money > 0 ? 'positive' : projectedEffects.money < 0 ? 'negative' : 'neutral'}`;
            
            // Set happiness value and style
            projectedHappiness.textContent = projectedEffects.happiness > 0 ? `+${projectedEffects.happiness}` : projectedEffects.happiness;
            projectedHappiness.className = `value ${projectedEffects.happiness > 0 ? 'positive' : projectedEffects.happiness < 0 ? 'negative' : 'neutral'}`;
            
            // Set CO2 value and style (CO2 reduction is good, so colors are reversed)
            projectedCo2.textContent = projectedEffects.co2 > 0 ? `+${projectedEffects.co2}` : projectedEffects.co2;
            projectedCo2.className = `value ${projectedEffects.co2 < 0 ? 'positive' : projectedEffects.co2 > 0 ? 'negative' : 'neutral'}`;
            
            // Update button states - use settings from current_round_changes or city's current settings
            const currentTransport = gameState.current_round_changes?.transportation?.[selectedCity] || city.transportation;
            const currentEnergy = gameState.current_round_changes?.energy_source?.[selectedCity] || city.energy_source;
            
            cityInfo.querySelectorAll('.transportation-buttons button').forEach(button => {
                button.classList.toggle('active', button.dataset.type === currentTransport);
                button.addEventListener('click', () => setTransportation(selectedCity, button.dataset.type));
            });
            
            cityInfo.querySelectorAll('.energy-buttons button').forEach(button => {
                button.classList.toggle('active', button.dataset.type === currentEnergy);
                button.addEventListener('click', () => setEnergySource(selectedCity, button.dataset.type));
            });
            
            // Clear old content and add new content
            cityDetails.innerHTML = '';
            cityDetails.appendChild(cityInfo);
            
            // Initialize chart
            initCityChart(selectedCity);
        }
        
        // Initialize city chart
        function initCityChart(cityId) {
            const city = gameState.cities[cityId];
            const ctx = cityDetails.querySelector('.city-chart').getContext('2d');
            
            // Get projected effects
            const projectedEffects = gameState.current_round_changes?.projected_effects?.[cityId] || {
                money: 0, 
                happiness: 0, 
                co2: 0
            };
            
            // Get current settings
            const currentTransport = gameState.current_round_changes?.transportation?.[cityId] || city.transportation;
            const currentEnergy = gameState.current_round_changes?.energy_source?.[cityId] || city.energy_source;
            
            // Destroy old chart instance
            if (cityCharts[cityId]) {
                cityCharts[cityId].destroy();
            }
            
            cityCharts[cityId] = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Happiness', 'Environment', 'Transport', 'Energy'],
                    datasets: [
                        {
                            label: `${city.name} Current Status`,
                            data: [
                                city.happiness,
                                100 - city.co2,
                                getTransportationScore(city.transportation),
                                getEnergyScore(city.energy_source)
                            ],
                            backgroundColor: 'rgba(52, 152, 219, 0.2)',
                            borderColor: 'rgba(52, 152, 219, 1)',
                            pointBackgroundColor: 'rgba(52, 152, 219, 1)',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: 'rgba(52, 152, 219, 1)'
                        },
                        {
                            label: `${city.name} Projected Status`,
                            data: [
                                Math.max(0, Math.min(100, city.happiness + projectedEffects.happiness)),
                                Math.max(0, Math.min(100, 100 - (city.co2 + projectedEffects.co2))),
                                getTransportationScore(currentTransport),
                                getEnergyScore(currentEnergy)
                            ],
                            backgroundColor: 'rgba(46, 204, 113, 0.2)',
                            borderColor: 'rgba(46, 204, 113, 1)',
                            pointBackgroundColor: 'rgba(46, 204, 113, 1)',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: 'rgba(46, 204, 113, 1)'
                        }
                    ]
                },
                options: {
                    scales: {
                        r: {
                            angleLines: {
                                display: true
                            },
                            suggestedMin: 0,
                            suggestedMax: 100
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: 'white'
                            }
                        }
                    }
                }
            });
        }
        
        // Get transportation score
        function getTransportationScore(transportation) {
            const scores = {
                "bicycle": 90,
                "scooter": 85,
                "electronic_car": 75,
                "electronic_bus": 80,
                "train": 70,
                "bus": 60,
                "car": 40,
                "airplane": 20,
                "potogan": 100
            };
            return scores[transportation] || 50;
        }
        
        // Get energy score
        function getEnergyScore(energy) {
            const scores = {
                "solar": 90,
                "wind": 85,
                "water": 80,
                "nuclear": 70,
                "automic": 85,
                "anti_material": 95,
                "mining": 30
            };
            return scores[energy] || 50;
        }
        
        // Update UI
        function updateUI() {
            yearElement.textContent = gameState.year;
            moneyElement.textContent = gameState.money;
            
            // Update money progress bar
            document.querySelector('.progress-fill.money').style.width = `${Math.min(100, gameState.money/10)}%`;
            
            // Update map markers
            for (const [cityId, city] of Object.entries(gameState.cities)) {
                const marker = document.getElementById(`marker-${cityId}`);
                if (marker) {
                    marker.classList.toggle('eliminated', city.eliminated);
                }
            }
            
            // If currently selected city is eliminated, clear selection
            if (selectedCity && gameState.cities[selectedCity].eliminated) {
                selectedCity = null;
            }
            
            // Update city details
            updateCityDetails();
            
            // Check game over
            if (gameState.game_over) {
                let message = "Game Over!";
                if (gameState.money <= 0) message += " The country went bankrupt.";
                
                // Check eliminated cities
                const eliminatedCities = Object.entries(gameState.cities)
                    .filter(([id, city]) => city.eliminated)
                    .map(([id, city]) => city.name);
                
                if (eliminatedCities.length > 0) {
                    message += ` The following cities were eliminated: ${eliminatedCities.join(', ')}.`;
                }
                
                if (Object.values(gameState.cities).every(city => city.eliminated)) {
                    message += " All cities have been eliminated.";
                }
                
                gameOverMessage.textContent = message;
                gameOverScreen.style.display = "flex";
            }
        }
        
        // Get game state
        async function fetchGameState() {
            try {
                const response = await fetch('http://localhost:8000/state');
                const data = await response.json();
                gameState = data;
                updateUI();
            } catch (error) {
                console.error('Error fetching game state:', error);
            }
        }
        
        // Set transportation method - now only previews effects without immediate application
        async function setTransportation(cityId, type) {
            try {
                const response = await fetch(`http://localhost:8000/action/transportation/${cityId}/${type}`, {
                    method: 'POST'
                });
                const data = await response.json();
                gameState = data.state;
                
                // Update UI to show preview effects
                updateUI();
                
            } catch (error) {
                console.error('Error setting transportation:', error);
            }
        }
        
        // Set energy source - now only previews effects without immediate application
        async function setEnergySource(cityId, type) {
            try {
                const response = await fetch(`http://localhost:8000/action/energy/${cityId}/${type}`, {
                    method: 'POST'
                });
                const data = await response.json();
                gameState = data.state;
                
                // Update UI to show preview effects
                updateUI();
                
            } catch (error) {
                console.error('Error setting energy source:', error);
            }
        }
        
        // Advance to next round
        async function nextRound() {
            try {
                // Switch to next video each round
                switchToNextVideo();
                
                const response = await fetch('http://localhost:8000/next-round', {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.message) {
                    alert(data.message);
                    return;
                }
                
                gameState = data.state;
                const news = data.news;
                
                // Display news
                const newsCard = document.createElement('div');
                newsCard.className = 'news-card';
                
                let effectsHTML = '';
                if (news.effects) {
                    if (news.effects.money) {
                        const sign = news.effects.money > 0 ? '+' : '';
                        effectsHTML += `<div class="effect">Money: ${sign}${news.effects.money}</div>`;
                    }
                    if (news.effects.happiness) {
                        const sign = news.effects.happiness > 0 ? '+' : '';
                        effectsHTML += `<div class="effect">Happiness: ${sign}${news.effects.happiness}</div>`;
                    }
                    if (news.effects.co2) {
                        const sign = news.effects.co2 > 0 ? '+' : '';
                        effectsHTML += `<div class="effect">CO2: ${sign}${news.effects.co2}</div>`;
                    }
                    if (news.effects.city) {
                        effectsHTML += `<div class="effect">Affected City: ${gameState.cities[news.effects.city].name}</div>`;
                    } else {
                        effectsHTML += `<div class="effect">Impact: National</div>`;
                    }
                }
                
                newsCard.innerHTML = `
                    <div class="news-title">Year ${gameState.year}: ${news.title}</div>
                    <div class="news-description">${news.description}</div>
                    <div class="effects">${effectsHTML}</div>
                `;
                
                newsContainer.prepend(newsCard);
                updateUI();
                
            } catch (error) {
                console.error('Error advancing round:', error);
            }
        }
        
        // Event listeners
        nextRoundButton.addEventListener('click', nextRound);
        restartButton.addEventListener('click', restartGame);
        restartGameButton.addEventListener('click', restartGame);
        
        // Welcome message with explanation of preview system
        function addWelcomeMessage() {
            const welcomeCard = document.createElement('div');
            welcomeCard.className = 'news-card';
            welcomeCard.innerHTML = `
                <div class="news-title">Welcome to the Swedish City Sustainability Game</div>
                <div class="news-description">
                    As the manager of Sweden, your task is to balance economic development, citizen happiness, and environmental protection.
                    Each round, you can choose different transportation methods and energy sources for each city, and the system will preview the effects without applying them immediately.
                    Click the "Next Round" button to apply all changes and advance to the next year. New events will happen each year, so make wise decisions!
                </div>
                <div class="effects">
                    <div class="effect">Goal: Keep national money > 0</div>
                    <div class="effect">Goal: Prevent city happiness from reaching 0</div>
                    <div class="effect">Goal: Prevent city CO2 from reaching 100</div>
                </div>
            `;
            newsContainer.innerHTML = '';
            newsContainer.appendChild(welcomeCard);
        }
        
        // Restart game
        async function restartGame() {
            try {
                const response = await fetch('http://localhost:8000/restart', {
                    method: 'POST'
                });
                const data = await response.json();
                gameState = data.state;
                
                // Ensure each city's eliminated state is reset
                for (const cityId in gameState.cities) {
                    gameState.cities[cityId].eliminated = false;
                }
                
                // Clear news and add welcome message
                addWelcomeMessage();
                
                // Clear selected city
                selectedCity = null;
                
                // Reinitialize city markers
                initCityMarkers();
                
                // Hide game over screen
                gameOverScreen.style.display = "none";
                
                updateUI();
            } catch (error) {
                console.error('Error restarting game:', error);
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initCityMarkers();
            addWelcomeMessage();
            initVideoPlayer();
            updateUI();
        });
    </script>
</body>
</html>